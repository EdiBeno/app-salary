<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <title>砖转 住 转</title>
    <style>
        /* CSS Reset and Body Styling */
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            display: flex; /* 砖砖 -flexbox  专 转 转 专砖 */
            justify-content: center;
            position: relative; /* 专转 拽 住 拽 驻转专  */
        }

        /*  专砖  祝 A4 - 专 */
        .invoice-container {
            width: 21cm;
            min-height: 29.7cm;
            background-color: #fff;
            padding: 2cm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            margin: 20px 0; /* 砖 注  */
        }

        /* RTL Alignment */
        h1, h2, h3, p, div, table { text-align: right; }
        
        .header {
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .header h1 {
            text-align: center;
            margin: 0;
        }

        .details { display: flex; justify-content: space-between; margin-bottom: 30px; padding-top: 20px; }
        .details > div { flex: 1; padding: 10px; border: 1px solid #eee; margin: 0 5px; }
        .item-table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        .item-table th, .item-table td { border: 1px solid #ddd; padding: 12px; text-align: right; }
        .item-table th { background-color: #f9f9f9; font-weight: bold; }
        .total-section { margin-top: 30px; width: 50%; margin-left: auto; border-top: 2px solid #333; padding-top: 10px; }
        .add-row-btn { margin-top: 10px; padding: 10px; cursor: pointer; }

        /* Input/Select Styling */
        .product-select, .quantity-input, .price-input {
            height: 30px;
            padding: 5px 8px;
            box-sizing: border-box;
            width: 100%;
        }

        /* --- 驻转专 专 砖, 抓 -A4, 爪  --- */
        .back-home-container {
            position: fixed; /* 拽 转 驻转专 拽 拽注 住 */
            top: 20px;       /* 20px 拽 注 砖 住 */
            right: 20px;     /* 20px 爪  砖 住 */
            z-index: 1000;   /*  砖驻转专 爪 注  */
        }

        .back-home-button {
            font-weight: bold;
            height: 0.5cm;
            font-size: 17px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            text-decoration: none;
        }

        /* 住转专转 驻转专 注转 驻住 */
        @media print {
            .back-home-container {
                display: none;
            }
        }

    .add-row-btn {
       /* background: #4CAF50; /* 专拽 住驻 */
         /* color: #fff; */
        border: none;
        padding: 4px 8px;
        cursor: pointer;
        font-size: 14px;
}

    @media print {
        .add-row-btn {
            display: none !important;
        }
    }

    </style>
</head>
<body>
    
    <!-- 驻转专 专 祝 专砖 -->
    <div class="back-home-container">
        <a href="{{ url_for('index') }}" class="back-home-button">
            注专 祝 专砖
        </a>

    <!-- Add an empty row with small height -->
<div style="height: 0.6cm;"></div>

    <!-- 驻转专 专 祝 爪专 -->
                <a href="{{ url_for('manage_products') }}" style="text-decoration: none;">
                    <button type="button" style="font-weight: bold; width: 3.6cm; height: 0.5cm; font-size: 17px; display: flex; align-items: center; justify-content: center;">
                        注专 祝 爪专 
                    </button>
                </a>

    <!-- Add an empty row with small height -->
<div style="height: 0.6cm;"></div>

    <!-- Print Button Invoice -->
        <button type="button" onclick="window.print()" class="print-button" style="font-weight: bold; width: 3.6cm; height: 0.6cm; font-size: 17px; display: flex; align-items: center; justify-content: center;">
             驻住 砖转
        </button>
        </a>

    <!-- Add an empty row with small height -->
<div style="height: 14.6cm;"></div>

    <!-- Print Button Invoice -->
        <button type="button" onclick="sendInvoice()" class="print-button" style="font-weight: bold; width: 6.6cm; height: 0.6cm; font-size: 17px; display: flex; align-items: center; justify-content: center;">
               砖 专砖转 住
        </button>
        </a>
    </div>

    <div class="invoice-container">
        <div class="header">
            <h1>砖转 住</h1>
            <p style="margin: 0;"><strong>转专:</strong> {{ invoice_date }}</p>
        </div>

        <div class="details">
            <div>
                <strong>驻专 注住拽:</strong><br>
                                {{ company.name }}<br>
                {{ company.address }}<br>
                        .驻./注.. {{ company.company_id }}<br>
                        驻: {{ company.phone }}
            </div>
            <div>
                <strong>驻专 拽:</strong><br>
                {{ client_name }}<br>
                {{ client_address }}<br>
                .驻./注.. {{ client_id }}
            </div>
        </div>
        
        <table class="item-table" id="invoice-items-table">
            <thead>
                <tr>
                    <th>转专</th>
                    <th>转</th>
                    <th>专 </th>
                    <th>住 </th>
                </tr>
            </thead>
            <tbody id="items-tbody">
                <!-- 砖专转 驻专 转住驻  爪注转 JavaScript -->
            </tbody>
        </table>

        <button class="add-row-btn" onclick="addRow()">+ 住祝 砖专</button>

        
        <div class="total-section">
          <table>
              <tr>
                  <td style="border: none;">住" 驻 注":</td>
                  <td style="border: none; text-align: left;"><span id="sub-total-display">0.00</span> 砖"</td>
              </tr>
              <tr>
                  <td style="border: none;">注":</td>
                  <!-- 住驻转 -ComboBox 注" -->
                  <td style="border: none; text-align: left;">
                      <select id="vat-rate-select" onchange="calculateTotals()">
                          {% for rate in vat_options %}
                          <option value="{{ rate }}" {% if rate == vat_rate %}selected{% endif %}>
                              {{ rate }}%
                          </option>
                          {% endfor %}
                      </select>
                      (<span id="vat-amount-display">0.00</span> 砖")
                  </td>
              </tr>
              <tr>
                  <td style="border: none;">**住  转砖:**</td>
                  <td style="border: none; text-align: left;"><h3><span id="grand-total-display">0.00</span> 砖"</h3></td>
              </tr>
          </table>
      </div>

        <div class="footer">
            <p>转 专 注 注住拽转!</p>
            <p>住驻专 拽爪 专砖转 住: <strong>{{ allocation_number }}</strong></p>
        </div>

    </div>


<script>
    const products = {{ inventory_items | tojson }};

    // 驻拽爪 专砖转 砖 住
    function calculateTotals() {
        let subTotal = 0;
        const tableBody = document.getElementById('items-tbody');
        Array.from(tableBody.children).forEach(row => {
            const quantity = parseFloat(row.children[1].querySelector('input').value) || 0;
            const price = parseFloat(row.children[2].querySelector('input').value) || 0;
            const total = quantity * price;
            row.children[3].textContent = total.toFixed(2);
            subTotal += total;
        });

        const vatRate = parseFloat(document.getElementById('vat-rate-select').value) || 0;
        const vatAmount = subTotal * (vatRate / 100);
        const grandTotal = subTotal + vatAmount;

        document.getElementById('sub-total-display').textContent = subTotal.toFixed(2);
        document.getElementById('vat-amount-display').textContent = vatAmount.toFixed(2);
        document.getElementById('grand-total-display').textContent = grandTotal.toFixed(2);
    }

    // 爪专转 select 砖 爪专 注 注 专
    function createProductSelectElement(priceInput) {
        const selectElement = document.createElement('select');
        selectElement.className = 'product-select'; 
        selectElement.name = 'product_id[]'; 

        let defaultOption = document.createElement('option');
        defaultOption.value = "";
        defaultOption.textContent = "专 爪专";
        selectElement.appendChild(defaultOption);

        products.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id; 
            option.textContent = product.name; 
            option.setAttribute('data-price', product.price); 
            selectElement.appendChild(option);
        });

        // 砖专 爪专, 注 转 砖 专
        selectElement.addEventListener('change', function() {
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const price = selectedOption.getAttribute('data-price') || 0;
            priceInput.value = parseFloat(price).toFixed(2);
            calculateTotals();
        });

        return selectElement;
    }

    function addRow() {
        const tableBody = document.getElementById('items-tbody');
        const newRow = document.createElement('tr');

        // 转 转专 注 select
        const descriptionCell = document.createElement('td');

        // 转 专 注 input
        const priceCell = document.createElement('td');
        const priceInput = document.createElement('input');
        priceInput.type = 'number';
        priceInput.value = '0.00';
        priceInput.name = 'price[]';
        priceInput.className = 'price-input';
        priceInput.style.width = '100px';
        priceInput.onchange = calculateTotals;
        priceInput.oninput = calculateTotals;
        priceCell.appendChild(priceInput);

        // 爪专转 select 注 reference priceInput
        const selectElement = createProductSelectElement(priceInput);
        descriptionCell.appendChild(selectElement);

        // 转 转
        const quantityCell = document.createElement('td');
        const quantityInput = document.createElement('input');
        quantityInput.type = 'number';
        quantityInput.value = '1';
        quantityInput.name = 'quantity[]';
        quantityInput.className = 'quantity-input';
        quantityInput.style.width = '100px';
        quantityInput.onchange = calculateTotals;
        quantityInput.oninput = calculateTotals;
        quantityCell.appendChild(quantityInput);

        // 转 住 
        const totalCell = document.createElement('td');
        totalCell.textContent = '0.00';

        newRow.appendChild(descriptionCell);
        newRow.appendChild(quantityCell);
        newRow.appendChild(priceCell);
        newRow.appendChild(totalCell);
        tableBody.appendChild(newRow);

        calculateTotals();
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (products.length > 0) {
            addRow();
        }
    });
</script>

<script>
function sendInvoice() {
    fetch("/send_invoice", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ invoice_id: "INV-2025-12345" }) //  砖转
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            alert("砖 爪! 住驻专 拽爪: " + data.allocation_number);
            // 驻砖专  注 转 转爪 祝
            document.getElementById("allocation-number-display").textContent = data.allocation_number;
        } else {
            alert("砖 砖: " + data.message);
        }
    })
    .catch(err => alert("砖转 转拽砖专转: " + err));
}
</script>

    <!--  DevTools F12 Browser Blocker Script  -->
    <script disable-devtool-auto src="https://cdn.jsdelivr.net/npm/disable-devtool"></script>

</body>
</html>
